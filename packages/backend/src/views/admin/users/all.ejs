<%- include('../../head'); %> <%- include('../navbar'); %>

<div class="container-fluid">
  <div id="alert-container"></div>

  <h2>All Users</h2>

  <table class="table">
    <thead>
      <tr>
        <th scope="col">User ID</th>
        <th scope="col">Email</th>
        <th scope="col">Password (Hashed)</th>
        <th scope="col">School ID</th>
        <th scope="col">Created</th>
        <th scope="col">Updated</th>
        <th scope="col">Actions</th>
      </tr>
    </thead>
    <tbody>
      <% users.forEach((user) => { %>
      <tr id="user-<%= user.id %>">
        <th scope="row"><%= user.id %></th>
        <td><%= user.email %></td>
        <td><%= user.password_hash %></td>
        <td><%= user.school_id %></td>
        <td><%= user.created_at %></td>
        <td><%= user.updated_at %></td>
        <td>
          <div class="btn-group">
            <button type="button" class="btn btn-danger" onclick="deleteUser(<%= user.id %>);">
              Delete
            </button>
          </div>
        </td>
      </tr>
      <% }); %>
    </tbody>
  </table>
</div>

<script>
  $(document).ready(() => {});

  const deleteUser = id => {
    fetch("http://localhost:3000/api/v1/users/delete/" + id, {
      method: "POST",
    })
      .then(response => response.json())
      .then(json => {
        if (json.error) {
          throw json.error;
        }
        showAlert("success", ["Deleted user!", "ID: " + json["id"], "School ID: " + json["school_id"], "Email: " + json["email"], "Password hash: " + json["password_hash"]]);
        $("#user-" + json["id"]).remove();
        console.log("Deleted user!");
        console.log(json);
      })
      .catch(err => {
        showAlert("danger", ["Failed to delete user!", err]);
        console.error("Failed to delete user!");
        console.error(err);
      });
  };

  function showAlert(alertType, contents) {
    const alert = `
<div class="alert alert-${alertType} alert-dismissible fade show" role="alert">
  ${contents.map(msg => msg + "<br>").join("")}
  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
    <span aria-hidden="true">&times;</span>
  </button>
</div>
    `.trim();
    $("#alert-container").empty();
    $("#alert-container").prepend(alert);
  }
</script>

<%- include('../../tail'); %>
